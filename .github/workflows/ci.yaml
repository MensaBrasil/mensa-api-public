name: CI

on:
  push:
    branches:
      - '**'

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  code_check:
    name: Code Checking
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: astral-sh/setup-uv@v1
        with:
          version: "latest"
      - name: Install dependencies
        run: uv sync -p 3.12
      - name: Run mypy type check
        run: uv run mypy .
      - name: Check for secrets
        run: |
          uv add detect-secrets
          uv run detect-secrets scan --baseline .secrets.baseline

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: astral-sh/setup-uv@v1
        with:
          version: "latest"
      - name: Install dependencies
        run: uv sync -p 3.12
      - name: Run tests with coverage
        env:
          api_host: ${{ secrets.api_host }}
          api_log_level: ${{ secrets.api_log_level }}
          api_port: ${{ secrets.api_port }}
          api_title: ${{ secrets.api_title }}
          data_route_api_key: ${{ secrets.data_route_api_key }}
          google_api_key: ${{ secrets.google_api_key }}
          openai_api_key: ${{ secrets.openai_api_key }}
          postgres_database: ${{ secrets.postgres_database }}
          postgres_host: ${{ secrets.postgres_host }}
          postgres_password: ${{ secrets.postgres_password }}
          postgres_user: ${{ secrets.postgres_user }}
          twilio_account_sid: ${{ secrets.twilio_account_sid }}
          twilio_auth_token: ${{ secrets.twilio_auth_token }}
          twilio_from_whatsapp_number: ${{ secrets.twilio_from_whatsapp_number }}
          whatsapp_route_api_key: WHATSAPP_ROUTE_API_KEY
          redis_host: localhost
          discord_client_id: state
          discord_client_secret: state
          discord_redirect_uri: state
          POSTGRES_RO_USER: mensa_ro
          POSTGRES_RO_PASSWORD: postgres
          SERVICE_ACCOUNT_FILE: credential_file.json
          GOOGLE_API_SCOPES: https://www.googleapis.com/auth/admin.directory.group
          GOOGLE_SERVICE_ACCOUNT: example@example.iam.gserviceaccount.com
          GOOGLE_WORKSPACE_CRONJOB_UPTIME_URL: testurl
        run: |
          uv run coverage run -m pytest -sv .
          uv run coverage report
      - name: Check coverage
        run: |
          COVERAGE=$(uv run coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          echo "Coverage is $COVERAGE%"
          if (( $(echo "$COVERAGE < 85" | bc -l) )); then
            echo "Code coverage is below 85%"
            exit 1
          fi

  security_scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Set up Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          ignore-unfixed: true
          exit-code: 1
          severity: MEDIUM
